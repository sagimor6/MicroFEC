name: CI

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'
  workflow_dispatch:
    

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: compilers
      run: sudo apt-get install clang gcc-multilib qemu-user libgcc-12-dev-arm64-cross libc6-dev-arm64-cross libgcc-12-dev-armel-cross libc6-dev-armel-cross
    - name: print cpu info
      run: cat /proc/cpuinfo
    - name: test native
      run: ARCH_CFLAGS="-DPERF_DEBUG -march=native -mtune=native" make clean fec_test
    - name: test 64bit clmul
      run: ARCH_CFLAGS="-DPERF_DEBUG -march=native -mtune=native -mpclmul" make clean fec_test
    - name: test 64bit avx2
      run: ARCH_CFLAGS="-DPERF_DEBUG -march=native -mtune=native -mno-pclmul -mavx2" make clean fec_test
    - name: test 64bit avx
      run: ARCH_CFLAGS="-DPERF_DEBUG -march=native -mtune=native -mno-pclmul -mno-avx2 -mavx" make clean fec_test
    - name: test 64bit sse2
      run: ARCH_CFLAGS="-DPERF_DEBUG -march=native -mtune=native -mno-pclmul -mno-avx2 -mno-avx -msse2" make clean fec_test
    - name: test 32bit clmul
      run: ARCH_CFLAGS="-DPERF_DEBUG -march=native -mtune=native -m32 -mpclmul" make clean fec_test
    - name: test 32bit avx2
      run: ARCH_CFLAGS="-DPERF_DEBUG -march=native -mtune=native -m32 -mno-pclmul -mavx2" make clean fec_test
    - name: test 32bit avx
      run: ARCH_CFLAGS="-DPERF_DEBUG -march=native -mtune=native -m32 -mno-pclmul -mno-avx2 -mavx" make clean fec_test
    - name: test 32bit sse2
      run: ARCH_CFLAGS="-DPERF_DEBUG -march=native -mtune=native -m32 -mno-pclmul -mno-avx2 -mno-avx -msse2" make clean fec_test
    - name: test 32bit sse
      run: ARCH_CFLAGS="-DPERF_DEBUG -march=native -mtune=native -m32 -mno-pclmul -mno-avx2 -mno-avx -mno-sse4.2 -mno-sse4.1 -mno-sse4 -mno-sse3 -mno-sse2 -msse" make clean fec_test
    - name: test 32bit mmx
      run: ARCH_CFLAGS="-DPERF_DEBUG -march=native -mtune=native -m32 -mno-pclmul -mno-avx2 -mno-avx -mno-sse4.2 -mno-sse4.1 -mno-sse4 -mno-sse3 -mno-sse2 -mno-sse -mmmx" make clean fec_test
    - name: test 32bit
      run: ARCH_CFLAGS="-DPERF_DEBUG -march=native -mtune=native -m32 -mno-pclmul -mno-avx2 -mno-avx -mno-sse4.2 -mno-sse4.1 -mno-sse4 -mno-sse3 -mno-sse2 -mno-sse -mno-mmx" make clean fec_test
    - name: test 64bit
      run: ARCH_CFLAGS="-DPERF_DEBUG -march=native -mtune=native -mno-pclmul -mno-avx2 -mno-avx -mno-sse4.2 -mno-sse4.1 -mno-sse4 -mno-sse3 -mno-sse2 -mno-sse -mno-mmx" make clean fec_test
    - name: test aarch64 clmul
      run: ARCH_CFLAGS="-DPERF_DEBUG --target=aarch64-unknown-linux -fuse-ld=lld -march=armv8-a+crypto" CROSS_FLAGS="-static" CROSS_RUNNER="qemu-aarch64" TEST_PARAMS="1000 200 500" make clean fec_test
    - name: test aarch64 simd
      run: ARCH_CFLAGS="-DPERF_DEBUG --target=aarch64-unknown-linux -fuse-ld=lld -march=armv8-a+nocrypto+simd" CROSS_FLAGS="-static" CROSS_RUNNER="qemu-aarch64" TEST_PARAMS="1000 200 500" make clean fec_test
    - name: test aarch64
      run: ARCH_CFLAGS="-DPERF_DEBUG --target=aarch64-unknown-linux -fuse-ld=lld -march=armv8-a+nocrypto+nosimd" CROSS_FLAGS="-static" CROSS_RUNNER="qemu-aarch64" TEST_PARAMS="1000 200 500" make clean fec_test
